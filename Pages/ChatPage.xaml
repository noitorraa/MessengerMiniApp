<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:MessengerMiniApp"
             x:Class="MessengerMiniApp.Pages.ChatPage"
             x:Name="chatPage"
             Title="Chat"
             BackgroundColor="{DynamicResource PrimaryColor}">

    <Grid RowDefinitions="*, Auto" ColumnDefinitions="*" Padding="10">
        <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
        <CollectionView x:Name="MessagesCollectionView" Grid.Row="0" Grid.Column="0"
                        BackgroundColor="DarkSlateGrey" SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <StackLayout Padding="10" Orientation="Horizontal"
                                 VerticalOptions="Center"
                                 HorizontalOptions="{Binding UserID, Converter={StaticResource IsCurrentUserConverter}, FallbackValue=Start}">
                        <!-- Ð’Ñ‹Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ -->
                        <StackLayout.Triggers>
                            <DataTrigger TargetType="StackLayout"
                                         Binding="{Binding UserID, Converter={StaticResource IsCurrentUserConverter}}"
                                         Value="True">
                                <Setter Property="HorizontalOptions" Value="End" />
                            </DataTrigger>
                        </StackLayout.Triggers>

                        <!-- ÐšÐ°Ñ€ÐºÐ°Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                        <Border Stroke="LightGray"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 10"
                                Padding="10"
                                BackgroundColor="{Binding UserID, Converter={StaticResource UserIdToColorConverter}}"
                                MaximumWidthRequest="250">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                                <Label Text="{Binding Content}"
                                       IsVisible="{Binding FileId, TargetNullValue=true}" />

                                <!-- ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² -->
                                <StackLayout IsVisible="{Binding FileId, TargetNullValue=false}">
                                    <Image Source="{Binding FileUrl}"
                                           IsVisible="{Binding FileType, StringFormat='image', TargetNullValue=false}" />
                                    <Button Text="Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»"
                                            Command="{Binding Source={x:Reference chatPage}, Path=DownloadFileCommand}"
                                            CommandParameter="{Binding FileUrl}"
                                            IsVisible="{Binding FileType, StringFormat='file', TargetNullValue=true}" />
                                </StackLayout>

                                <!-- Ð’Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ -->
                                <StackLayout Grid.Row="1" Orientation="Horizontal" HorizontalOptions="End" Spacing="5">
                                    <Label Text="{Binding CreatedAt, StringFormat='{0:HH:mm}'}"
                                           TextColor="LightGray" FontSize="12" />
                                    <Label Text="{Binding Status, Converter={StaticResource StatusToTextConverter}}"
                                           TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                           IsVisible="{Binding UserID, Converter={StaticResource IsOutgoingMessageConverter}}" />
                                </StackLayout>
                            </Grid>
                        </Border>
                    </StackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° Ñ‚ÐµÐºÑÑ‚Ð° Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ¸ -->
        <Grid Grid.Row="1" Grid.Column="0" Padding="10"
              BackgroundColor="{DynamicResource SecondaryColor}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Button Text="ðŸ“Ž" Clicked="OnAttachClicked" BackgroundColor="Transparent"
                    TextColor="White" FontSize="24" Padding="10" Grid.Column="0" />
            <Entry x:Name="MessageEntry" Placeholder="Type a message" PlaceholderColor="LightGray"
                   TextColor="White" BackgroundColor="{DynamicResource EntryBackgroundColor}"
                   Margin="10,0" Grid.Column="1" />
            <Button Text="Send" Clicked="OnSendClicked"
                    BackgroundColor="{DynamicResource AccentColor}" TextColor="White"
                    CornerRadius="10" Padding="10" Grid.Column="2" />
        </Grid>
    </Grid>
</ContentPage>
