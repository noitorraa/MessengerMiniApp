<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:MessengerMiniApp"
             x:Class="MessengerMiniApp.Pages.ChatPage"
             x:Name="chatPage"
             Title="Chat"
             BackgroundColor="{DynamicResource PrimaryColor}">

    <Grid RowDefinitions="*, Auto" ColumnDefinitions="*" Padding="10">
        <!-- Список сообщений -->
        <CollectionView x:Name="MessagesCollectionView" Grid.Row="0" Grid.Column="0"
                        BackgroundColor="DarkSlateGrey" SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <StackLayout Padding="10" Orientation="Horizontal"
                                 VerticalOptions="Center"
                                 HorizontalOptions="{Binding UserID, Converter={StaticResource IsCurrentUserConverter}, FallbackValue=Start}">
                        <!-- Выравнивание в зависимости от отправителя -->
                        <StackLayout.Triggers>
                            <DataTrigger TargetType="StackLayout"
                                         Binding="{Binding UserID, Converter={StaticResource IsCurrentUserConverter}}"
                                         Value="True">
                                <Setter Property="HorizontalOptions" Value="End" />
                            </DataTrigger>
                        </StackLayout.Triggers>

                        <!-- Каркас сообщения -->
                        <Border Stroke="LightGray"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 10"
                                Padding="10"
                                BackgroundColor="{Binding UserID, Converter={StaticResource UserIdToColorConverter}}"
                                MaximumWidthRequest="250">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- Текст сообщения -->
                                <Label Text="{Binding Content}"
                                       IsVisible="{Binding FileId, TargetNullValue=true}" />

                                <!-- Отображение файлов -->
                                <StackLayout IsVisible="{Binding FileId, TargetNullValue=false}">
                                    <Image Source="{Binding FileUrl}"
                                           IsVisible="{Binding FileType, StringFormat='image', TargetNullValue=false}" />
                                    <Button Text="Скачать файл"
                                            Command="{Binding Source={x:Reference chatPage}, Path=DownloadFileCommand}"
                                            CommandParameter="{Binding FileUrl}"
                                            IsVisible="{Binding FileType, StringFormat='file', TargetNullValue=true}" />
                                </StackLayout>

                                <!-- Время отправки и статус -->
                                <StackLayout Grid.Row="1" Orientation="Horizontal" HorizontalOptions="End" Spacing="5">
                                    <Label Text="{Binding CreatedAt, StringFormat='{0:HH:mm}'}"
                                           TextColor="LightGray" FontSize="12" />
                                    <Label Text="{Binding Status, Converter={StaticResource StatusToTextConverter}}"
                                           TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                           IsVisible="{Binding UserID, Converter={StaticResource IsOutgoingMessageConverter}}" />
                                </StackLayout>
                            </Grid>
                        </Border>
                    </StackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Поле ввода текста и кнопки -->
        <Grid Grid.Row="1" Grid.Column="0" Padding="10"
              BackgroundColor="{DynamicResource SecondaryColor}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Button Text="📎" Clicked="OnAttachClicked" BackgroundColor="Transparent"
                    TextColor="White" FontSize="24" Padding="10" Grid.Column="0" />
            <Entry x:Name="MessageEntry" Placeholder="Type a message" PlaceholderColor="LightGray"
                   TextColor="White" BackgroundColor="{DynamicResource EntryBackgroundColor}"
                   Margin="10,0" Grid.Column="1" />
            <Button Text="Send" Clicked="OnSendClicked"
                    BackgroundColor="{DynamicResource AccentColor}" TextColor="White"
                    CornerRadius="10" Padding="10" Grid.Column="2" />
        </Grid>
    </Grid>
</ContentPage>
